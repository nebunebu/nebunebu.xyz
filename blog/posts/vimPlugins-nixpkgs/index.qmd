---
title: "Adding Neovim Plugins to Nixpkgs"
author: "nebu"
date: "2024-08-24"
categories: [nix, vim, code]
image: "image.jpg"
draft: true
---

I have manually edited `vim-plugin-names`. 

Running the `update.py` script from a nix-shell with `python3` installed give the error,

```txt
editors/vim/plugins on ÓÇ† vimPlugins [!] via üêç v3.11.9 via ‚ùÑÔ∏è   impure (shell)
‚ùØ python update.py
Traceback (most recent call last):
  File "/home/nebu/Clones/nixpkgs/pkgs/applications/editors/vim/plugins/update.py", line 40, in <module>
    import pluginupdate
ModuleNotFoundError: No module named 'pluginupdate'
```

If I edit the `vim-plugin-names` and `cd` to the root of the `nixpkgs` dir and run `nix-shell -p vimPluginsUpdater --run vimplugins-updater`, the `generated.nix` file does start to update, but it takes a long time since it is updating 1469 plugins and ultimately fails,

```sh
pkgs/applications/editors/vim/plugins/generated.nix
committing to nixpkgs "vimPlugins: update on 2024-08-12"
<urlopen error _ssl.c:989: The handshake operation timed out>, Retrying in 3 seconds...
1469 plugins were checked
error:
       ‚Ä¶ while evaluating the attribute 'vimPlugins.nvim-treesitter.src.rev'

         at /home/nebu/Clones/nixpkgs/pkgs/top-level/all-packages.nix:39291:3:

        39290|
        39291|   vimPlugins = recurseIntoAttrs (callPackage ../applications/editors/vim/plugins {
             |   ^
        39292|     luaPackages = lua51Packages;

       ‚Ä¶ in the left operand of the update (//) operator

         at /home/nebu/Clones/nixpkgs/lib/attrsets.nix:2076:11:

         2075|     attrs:
         2076|     attrs // { recurseForDerivations = true; };
             |           ^
         2077|

       (stack trace truncated; use '--show-trace' to show the full trace)

       error: syntax error, unexpected '='

       at /home/nebu/Clones/nixpkgs/pkgs/applications/editors/vim/plugins/generated.nix:1617:4:

         1616|
         1617|    = buildVimPlugin {
             |    ^
         1618|     pname = "";
Traceback (most recent call last):
  File "/nix/store/fw4w3xhlnvkdz6hl3hi2frwpd8zf03fv-vim-plugins-updater-0.1/bin/..vim-plugins-updater-wrapped-wrapped", line 174, in <module>
    main()
  File "/nix/store/fw4w3xhlnvkdz6hl3hi2frwpd8zf03fv-vim-plugins-updater-0.1/bin/..vim-plugins-updater-wrapped-wrapped", line 170, in main
    editor.run()
  File "/nix/store/fw4w3xhlnvkdz6hl3hi2frwpd8zf03fv-vim-plugins-updater-0.1/lib/pluginupdate.py", line 567, in run
    getattr(self, command)(args)
  File "/nix/store/fw4w3xhlnvkdz6hl3hi2frwpd8zf03fv-vim-plugins-updater-0.1/bin/..vim-plugins-updater-wrapped-wrapped", line 129, in update
    pluginupdate.update_plugins(self, args)
  File "/nix/store/fw4w3xhlnvkdz6hl3hi2frwpd8zf03fv-vim-plugins-updater-0.1/lib/pluginupdate.py", line 809, in update_plugins
    update()
  File "/nix/store/fw4w3xhlnvkdz6hl3hi2frwpd8zf03fv-vim-plugins-updater-0.1/lib/pluginupdate.py", line 442, in update
    self.generate_nix(plugins, outfile)
  File "/nix/store/fw4w3xhlnvkdz6hl3hi2frwpd8zf03fv-vim-plugins-updater-0.1/bin/..vim-plugins-updater-wrapped-wrapped", line 62, in generate_nix
    nvim_treesitter_rev = pluginupdate.run_nix_expr(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/fw4w3xhlnvkdz6hl3hi2frwpd8zf03fv-vim-plugins-updater-0.1/lib/pluginupdate.py", line 350, in run_nix_expr
    out = subprocess.check_output(cmd, timeout=90)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/pfv4raslwhi3101k342752v65zxkwrxq-python3-3.11.9/lib/python3.11/subprocess.py", line 466, in check_output
    return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/pfv4raslwhi3101k342752v65zxkwrxq-python3-3.11.9/lib/python3.11/subprocess.py", line 571, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command '['nix', 'eval', '--extra-experimental-features', 'nix-command', '--impure', '--json', '--expr', '(import <localpkgs> { }).vimPlugins.nvim-treesitter.src.rev', '--nix-path', 'localpkgs=/home/nebu/Clones/nixpkgs']' returned non-zero exit status 1.
```

You say

> the generated.nix file is generated by update.py and can be ignored

But I believe that I cannot merely add an entry to `vim-plugin-names`, because I made that mistake once before: https://github.com/NixOS/nixpkgs/pull/307373#discussion_r1584841494

> this PR does not update `generated.nix`, so it doesn't actually add the package to `nixpkgs`
